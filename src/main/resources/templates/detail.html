<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/page.css}">
</head>
<body>
    <!-- ê³µí†µ ë©”ë‰´ -->
    <div th:replace="fragments/header :: header"></div>
    <script th:inline="javascript">
        const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
    </script>


    <div class="comm_container">
          <h2 class="page-title">ê²Œì‹œê¸€ ìƒì„¸</h2>
          <div class="post-header">
              <h2 th:text="${post.title}" class="post-title"></h2>

              <div class="post-meta">
                  <span th:text="${post.writer}">ìµëª…</span>
                  (<span th:text="${post.ipAddress}">000.000</span>)
                  |
                  <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">2025-04-22</span>
              </div>
          </div>

          <hr>

          <div class="post-body">
              <p th:text="${post.content}" class="post-content"></p>
          </div>


          <div th:if="${post.fileName != null and (#strings.contains(post.fileName.toLowerCase(), '.jpg')
                    or #strings.contains(post.fileName.toLowerCase(), '.png')
                    or #strings.contains(post.fileName.toLowerCase(), '.jpeg')
                    or #strings.contains(post.fileName.toLowerCase(), '.gif'))}">
              <img th:src="@{'/files/' + ${post.fileName}}" alt="ì²¨ë¶€ ì´ë¯¸ì§€" style="max-width:100%; margin-top:10px;">
          </div>
          <div class="file-preview-box">
              <div class="file-preview-item" th:if="${post.fileName != null}">
                  <p>
                      <strong>ì²¨ë¶€íŒŒì¼ ë‹¤ìš´ë¡œë“œ:</strong>
                      <span th:text="${post.fileName}"></span>
                      <a th:href="@{'/files/' + ${post.fileName}}" download class="btn-download">ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</a>
                  </p>
              </div>
          </div>


          <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ -->
          <div  style="margin-top: 30px;" th:if="${#authorization.expression('isAuthenticated()')}">
              <a th:href="@{'/api/posts/' + ${post.id} + '/edit'}" class="btn-base btn-edit">ìˆ˜ì •</a>
              <form th:action="@{'/api/posts/' + ${post.id} + '/delete'}" method="post"  style="display:inline;">
                  <button type="submit" class="btn-base btn-delete" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
              </form>
          </div>


          <div style="text-align: center; margin-top: 20px; font-size: x-large;">
              <a href="/api/posts/community" class="btn-go-list">â† ëª©ë¡ìœ¼ë¡œ</a>
          </div>

          <hr>

          <!-- ëŒ“ê¸€ ì˜ì—­ -->
          <div class="comment-section">
              <h3>ğŸ’¬ ëŒ“ê¸€</h3>
              <div id="commentSection"></div>

              <div  style="margin-top: 30px;" th:if="${#authorization.expression('isAuthenticated()')}">
                  <h4>ëŒ“ê¸€ ì‘ì„±</h4>
                  <input type="text" id="newCommentWriter" placeholder="ì‘ì„±ì"><br>
                  <textarea id="newCommentContent" rows="3" cols="60" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea><br>
                  <button onclick="submitNewComment()">ëŒ“ê¸€ë“±ë¡</button>
              </div>
          </div>
          <br>
      </div>

      <script th:inline="javascript">
          const postId = [[${post.id}]];/* ê²Œì‹œê¸€ idë¥¼ ì—¬ê¸°ì„œ ê°€ì ¸ì™€ì•¼ í•¨ (ì˜ˆ: URL íŒŒì‹±) */;
          console.log('postId?? ' + postId);
          const userIsAdmin = false; // ë‚˜ì¤‘ì— ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì—°ë™ë˜ë©´ ë°”ê¿”ì•¼ í•¨

          // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
          async function loadComments() {
            const response = await fetch(`/api/comments?postId=${postId}`);
            const comments = await response.json();

            const container = document.getElementById('commentSection');
            container.innerHTML = ''; // ì´ˆê¸°í™”

            // ëŒ“ê¸€ íŠ¸ë¦¬ êµ¬ì¡°ë¡œ êµ¬ì„±
            const commentMap = {};
            comments.forEach(c => {
              commentMap[c.id] = { ...c, children: [] };
            });
            const rootComments = [];

            comments.forEach(c => {
              if (c.parentId) {
                commentMap[c.parentId].children.push(commentMap[c.id]);
              } else {
                rootComments.push(commentMap[c.id]);
              }
            });

            rootComments.forEach(c => renderComment(c, container));
          }

          // ëŒ“ê¸€ ë Œë”ë§ í•¨ìˆ˜
          function renderComment(comment, container, depth = 0) {
            const div = document.createElement('div');
            div.style.marginLeft = `${depth * 20}px`; // ë“¤ì—¬ì“°ê¸°

            console.log('comment : ', comment);

            const ipDisplay = userIsAdmin
              ? comment.maskedIp || 'unknown'
              : (comment.maskedIp ? comment.maskedIp.replace(/\.\d+$/, '.xxx') : 'unknown');

            let buttonHtml = '';
            if (isAuthenticated) {
              buttonHtml = `
                <button onclick="showReplyForm(${comment.id})">ë‹µê¸€</button>
                <button onclick="showEditForm(${comment.id}, '${comment.content.replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
                <button onclick="deleteComment(${comment.id})">ì‚­ì œ</button>
                <div id="replyForm-${comment.id}"></div>
                <div id="editForm-${comment.id}"></div>
              `;
            }

            div.innerHTML = `
              <div style="border-bottom:1px solid #ccc; padding:5px 0;">
                <strong>${comment.writer}</strong> (${ipDisplay}) - ${new Date(comment.createdAt).toLocaleString()}<br>
                <span id="comment-content-${comment.id}">${comment.content}</span>
                ${buttonHtml}
              </div>
            `;

            container.appendChild(div);

            comment.children.forEach(child => renderComment(child, container, depth + 1));
          }


          // ëŒ€ëŒ“ê¸€ ì…ë ¥ í¼ í‘œì‹œ
          function showReplyForm(parentId) {
            const replyDiv = document.getElementById(`replyForm-${parentId}`);
            replyDiv.innerHTML = `
              <textarea id="replyContent-${parentId}" rows="2" cols="50"></textarea><br>
              <input type="text" id="replyWriter-${parentId}" placeholder="ì‘ì„±ì"/><br>
              <button onclick="submitReply(${parentId})">ë“±ë¡</button>
            `;
          }

          // ëŒ€ëŒ“ê¸€ ì „ì†¡
          async function submitReply(parentId) {
            const content = document.getElementById(`replyContent-${parentId}`).value;
            const writer = document.getElementById(`replyWriter-${parentId}`).value;

            await fetch('/api/comments', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                postId: postId,
                content: content,
                writer: writer,
                parentId: parentId
              })
            });

            loadComments(); // ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          }

          // ìµœìƒìœ„ ëŒ“ê¸€ ì „ì†¡
          async function submitNewComment() {
              const content = document.getElementById("newCommentContent").value;
              const writer = document.getElementById("newCommentWriter").value;

              if (!content.trim() || !writer.trim()) {
                alert("ì‘ì„±ìì™€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
              }

              await fetch('/api/comments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  postId: postId,
                  content: content,
                  writer: writer,
                  parentId: null
                })
              });

              // ì…ë ¥ê°’ ì´ˆê¸°í™”
              document.getElementById("newCommentContent").value = '';
              document.getElementById("newCommentWriter").value = '';

              // ëŒ“ê¸€ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
              loadComments();
          }

          function showEditForm(commentId, originalContent) {
            const editDiv = document.getElementById(`editForm-${commentId}`);
            editDiv.innerHTML = `
              <textarea id="editContent-${commentId}" rows="2" cols="50">${originalContent}</textarea><br>
              <button onclick="submitEdit(${commentId})">ì €ì¥</button>
              <button onclick="cancelEdit(${commentId})">ì·¨ì†Œ</button>
            `;
          }

          async function submitEdit(commentId) {
            const newContent = document.getElementById(`editContent-${commentId}`).value;

            if (!newContent.trim()) {
              alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
              return;
            }

            await fetch(`/api/comments/${commentId}`, {
              method: 'PUT', // or PATCH
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content: newContent })
            });

            loadComments(); // ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          }

          function cancelEdit(commentId) {
            const editDiv = document.getElementById(`editForm-${commentId}`);
            editDiv.innerHTML = '';
          }

          async function deleteComment(commentId) {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            await fetch(`/api/comments/${commentId}`, {
              method: 'DELETE'
            });

            loadComments();
          }







          // í˜ì´ì§€ ë¡œë”© ì‹œ ì‹¤í–‰
          window.onload = loadComments;
    </script>
    <!-- í˜ì´ì§€ ë‚´ìš© ë -->

    <!-- alert ë©”ì‹œì§€ (ì‚­ì œ ì‹¤íŒ¨ ë“±) -->
    <script th:if="${errorMessage}" th:inline="javascript">
        alert([[${errorMessage}]]);
    </script>



</body>
</html>