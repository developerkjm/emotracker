<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</title>
</head>
<body>
    <h1>ğŸ“„ ê²Œì‹œê¸€ ìƒì„¸</h1>

    <p><strong>ì œëª©:</strong> <span th:text="${post.title}"></span></p>
    <p><strong>ë‚´ìš©:</strong> <span th:text="${post.content}"></span></p>
    <p><strong>ì‘ì„±ì:</strong> <span th:text="${post.writer}"></span></p>
    <p><strong>ì‘ì„±ì¼:</strong> <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span></p>
    <p><strong>IP:</strong> <span th:text="${post.ipAddress}"></span></p>

    <div th:if="${post.fileName != null}">
        <p><strong>ì²¨ë¶€íŒŒì¼:</strong> <a th:href="@{'/uploads/' + ${post.fileName}}" th:text="${post.fileName}"></a></p>
        -> ì‹¤ì œ ì„œë²„ ì£¼ì„œë¥¼ ì ì–´ì¤˜ì•¼ ë‹¤ìš´ë¡œë“œê°€ ë¨.
        <p><strong>ì²¨ë¶€íŒŒì¼:</strong> <a th:href="@{'/files/' + ${post.fileName}}" th:text="${post.fileName}"></a>
        </p>
    </div>

    <a href="/"><button>ëª©ë¡ìœ¼ë¡œ</button></a>

    <!-- ëŒ“ê¸€ ì˜ì—­ -->
    <h3>ğŸ’¬ ëŒ“ê¸€</h3>
    <div id="commentSection"></div>

    <h4>âœï¸ ëŒ“ê¸€ ì‘ì„±</h4>
    <textarea id="newCommentContent" rows="3" cols="60" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea><br>
    <input type="text" id="newCommentWriter" placeholder="ì‘ì„±ì"><br>
    <button onclick="submitNewComment()">ë“±ë¡</button>
    <hr>

    <script th:inline="javascript">
        const postId = [[${post.id}]];/* ê²Œì‹œê¸€ idë¥¼ ì—¬ê¸°ì„œ ê°€ì ¸ì™€ì•¼ í•¨ (ì˜ˆ: URL íŒŒì‹±) */;
        console.log('postId?? ' + postId);
        const userIsAdmin = false; // ë‚˜ì¤‘ì— ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì—°ë™ë˜ë©´ ë°”ê¿”ì•¼ í•¨

        // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadComments() {
          const response = await fetch(`/api/comments?postId=${postId}`);
          const comments = await response.json();

          const container = document.getElementById('commentSection');
          container.innerHTML = ''; // ì´ˆê¸°í™”

          // ëŒ“ê¸€ íŠ¸ë¦¬ êµ¬ì¡°ë¡œ êµ¬ì„±
          const commentMap = {};
          comments.forEach(c => {
            commentMap[c.id] = { ...c, children: [] };
          });
          const rootComments = [];

          comments.forEach(c => {
            if (c.parentId) {
              commentMap[c.parentId].children.push(commentMap[c.id]);
            } else {
              rootComments.push(commentMap[c.id]);
            }
          });

          rootComments.forEach(c => renderComment(c, container));
        }

        // ëŒ“ê¸€ ë Œë”ë§ í•¨ìˆ˜
        function renderComment(comment, container, depth = 0) {
          const div = document.createElement('div');
          div.style.marginLeft = `${depth * 20}px`; // ë“¤ì—¬ì“°ê¸°

          // const ipDisplay = userIsAdmin ? comment.ip : comment.ip.replace(/\.\d+$/, '.xxx');
          const ipDisplay = userIsAdmin  ? comment.ip || 'unknown'  : (comment.ip ? comment.ip.replace(/\.\d+$/, '.xxx') : 'unknown');


          div.innerHTML = `
            <div style="border-bottom:1px solid #ccc; padding:5px 0;">
              <strong>${comment.writer}</strong> (${ipDisplay}) - ${new Date(comment.createdAt).toLocaleString()}<br>
              <span id="comment-content-${comment.id}">${comment.content}</span>
              <button onclick="showReplyForm(${comment.id})">ë‹µê¸€</button>
              <button onclick="showEditForm(${comment.id}, '${comment.content.replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
              <button onclick="deleteComment(${comment.id})">ì‚­ì œ</button>
              <div id="replyForm-${comment.id}"></div>
              <div id="editForm-${comment.id}"></div>
            </div>
          `;
          container.appendChild(div);

          comment.children.forEach(child => renderComment(child, container, depth + 1));
        }

        // ëŒ€ëŒ“ê¸€ ì…ë ¥ í¼ í‘œì‹œ
        function showReplyForm(parentId) {
          const replyDiv = document.getElementById(`replyForm-${parentId}`);
          replyDiv.innerHTML = `
            <textarea id="replyContent-${parentId}" rows="2" cols="50"></textarea><br>
            <input type="text" id="replyWriter-${parentId}" placeholder="ì‘ì„±ì"/><br>
            <button onclick="submitReply(${parentId})">ë“±ë¡</button>
          `;
        }

        // ëŒ€ëŒ“ê¸€ ì „ì†¡
        async function submitReply(parentId) {
          const content = document.getElementById(`replyContent-${parentId}`).value;
          const writer = document.getElementById(`replyWriter-${parentId}`).value;

          await fetch('/api/comments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              postId: postId,
              content: content,
              writer: writer,
              parentId: parentId
            })
          });

          loadComments(); // ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        }

        // ìµœìƒìœ„ ëŒ“ê¸€ ì „ì†¡
        async function submitNewComment() {
            const content = document.getElementById("newCommentContent").value;
            const writer = document.getElementById("newCommentWriter").value;

            if (!content.trim() || !writer.trim()) {
              alert("ì‘ì„±ìì™€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
              return;
            }

            await fetch('/api/comments', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                postId: postId,
                content: content,
                writer: writer,
                parentId: null
              })
            });

            // ì…ë ¥ê°’ ì´ˆê¸°í™”
            document.getElementById("newCommentContent").value = '';
            document.getElementById("newCommentWriter").value = '';

            // ëŒ“ê¸€ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            loadComments();
        }

        function showEditForm(commentId, originalContent) {
          const editDiv = document.getElementById(`editForm-${commentId}`);
          editDiv.innerHTML = `
            <textarea id="editContent-${commentId}" rows="2" cols="50">${originalContent}</textarea><br>
            <button onclick="submitEdit(${commentId})">ì €ì¥</button>
            <button onclick="cancelEdit(${commentId})">ì·¨ì†Œ</button>
          `;
        }

        async function submitEdit(commentId) {
          const newContent = document.getElementById(`editContent-${commentId}`).value;

          if (!newContent.trim()) {
            alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
          }

          await fetch(`/api/comments/${commentId}`, {
            method: 'PUT', // or PATCH
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: newContent })
          });

          loadComments(); // ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        }

        function cancelEdit(commentId) {
          const editDiv = document.getElementById(`editForm-${commentId}`);
          editDiv.innerHTML = '';
        }

        async function deleteComment(commentId) {
          if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

          await fetch(`/api/comments/${commentId}`, {
            method: 'DELETE'
          });

          loadComments();
        }







        // í˜ì´ì§€ ë¡œë”© ì‹œ ì‹¤í–‰
        window.onload = loadComments;
    </script>

</body>


</html>
