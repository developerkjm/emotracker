<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Calendar</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/page.css}">
    <!-- FullCalendar -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

</head>
<body>

    <!-- ë©”ë‰´ -->
    <div th:replace="fragments/header :: header"></div>

    <h2 style="text-align:center;">Calendar</h2>
    <div id="calendar"></div>

    <!-- ëª¨ë‹¬ -->
    <div id="emotionModal" style="display:none; position:fixed; top:30%; left:50%; transform:translateX(-50%);
 background:white; border-radius:10px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.3); z-index:999;">
        <h3 style="font-size:20px;">ê°ì • ì„ íƒ</h3>
        <div id="emojiChoices" style="font-size:28px; margin-bottom:10px;">
            <span onclick="selectEmoji(this)">ğŸ˜Š</span>
            <span onclick="selectEmoji(this)">ğŸ˜­</span>
            <span onclick="selectEmoji(this)">ğŸ˜Œ</span>
            <span onclick="selectEmoji(this)">ğŸ˜</span>
            <span onclick="selectEmoji(this)">ğŸ˜ </span>
            <span onclick="selectEmoji(this)">ğŸ˜¡</span>
            <span onclick="selectEmoji(this)">â¤ï¸</span>
            <span onclick="selectEmoji(this)">ğŸ˜¶</span>
        </div>

        <input type="text" id="modalEmoji" placeholder="ì„ íƒí•œ ì´ëª¨ì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë¨" readonly style="font-size:24px; border:none; background-color:#f3f4f6; width:100%; text-align:center; margin-bottom:10px;">

        <p><strong>ë‚ ì§œ:</strong> <input type="date" id="modalDate"></p>

        <p><strong>ë©”ëª¨:</strong></p>
        <textarea id="modalMemo" style="width:100%; height:80px;"></textarea>

        <div th:if="${#authorization.expression('isAuthenticated()')}">            <div style="text-align:right;">
                <button id="submitButton" onclick="">ë“±ë¡</button>
                <button onclick="closeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>


    <!-- ëª¨ë‹¬ ë°°ê²½ ì˜¤ë²„ë ˆì´ -->
    <div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
 background-color:rgba(0,0,0,0.5); z-index:998;" onclick="closeModal()"></div>

    <script>
        let currentEditId = null;
        let isEditMode = false;

        function selectEmoji(span) {
          const selectedEmoji = span.textContent;
          document.getElementById('modalEmoji').value = selectedEmoji;

          // ì„ íƒí•œ ê²ƒë§Œ í•˜ì´ë¼ì´íŠ¸
          document.querySelectorAll('#emojiChoices span').forEach(s => s.style.backgroundColor = '');
          span.style.backgroundColor = '#dbeafe'; // ì—°í•œ íŒŒë‘ìƒ‰
        }


        function openModal(mode, date = null, event = null) {
          isEditMode = mode === 'edit';

          const titleInput = document.getElementById('modalEmoji');
          const dateInput = document.getElementById('modalDate');
          const memoInput = document.getElementById('modalMemo');
          const button = document.getElementById('submitButton');

          if (isEditMode && event) {
            currentEditId = event.id;
            titleInput.value = event.title;
            dateInput.value = event.startStr;
            memoInput.value = event.extendedProps.memo || '';
            button.innerText = 'ìˆ˜ì •';
            button.onclick = submitEdit;
          } else {
            currentEditId = null;
            titleInput.value = '';
            dateInput.value = date;
            memoInput.value = '';
            button.innerText = 'ë“±ë¡';
            button.onclick = submitNewEmotion;
          }

          document.getElementById('emotionModal').style.display = 'block';
          document.getElementById('modalOverlay').style.display = 'block';
        }


        document.addEventListener('DOMContentLoaded', function () {
          const calendarEl = document.getElementById('calendar');

          const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            height: 'auto',
            events: async function(fetchInfo, successCallback, failureCallback) {
              try {
                const res = await fetch('/api/emotion-entries');
                const data = await res.json();
                console.log('data #^&$^%$   :  ' + data);
                data.forEach(e => {
                  console.log('emoji:', e.title, 'date:', e.start, 'memo:', e.memo);
                });

                // ì´ë²¤íŠ¸ í¬ë§·: title + start + memoë¥¼ tooltipì²˜ëŸ¼ ì‚¬ìš©
                const events = data.map(entry => ({
                  id: entry.id,             // âœ… ì´ê²Œ ìˆì–´ì•¼ ìˆ˜ì • ìš”ì²­ ë³´ë‚¼ ìˆ˜ ìˆì–´
                  title: entry.title,     // âœ… ì´ëª¨ì§€ ë“¤ì–´ê°ˆ ê³³
                  start: entry.start,      // âœ… ë‚ ì§œ
                  extendedProps: {
                    memo: entry.memo      // âœ… íˆ´íŒìœ¼ë¡œ ë³´ì—¬ì¤„ ë©”ëª¨
                  }
                }));

                successCallback(events);
              } catch (err) {
                console.error('Failed to load emotion data:', err);
                failureCallback(err);
              }
            },
            eventDidMount: function(info) {
              // íˆ´íŒìœ¼ë¡œ memo ë³´ì—¬ì£¼ê¸°
              const memo = info.event.extendedProps.memo;
              if (memo) {
                const tooltip = document.createElement('div');
                tooltip.innerText = memo;
                tooltip.style.position = 'absolute';
                tooltip.style.padding = '5px 10px';
                tooltip.style.background = '#333';
                tooltip.style.color = '#fff';
                tooltip.style.fontSize = '12px';
                tooltip.style.borderRadius = '4px';
                tooltip.style.pointerEvents = 'none';
                tooltip.style.display = 'none';
                document.body.appendChild(tooltip);

                info.el.addEventListener('mouseenter', e => {
                  tooltip.style.left = e.pageX + 10 + 'px';
                  tooltip.style.top = e.pageY + 'px';
                  tooltip.style.display = 'block';
                });
                info.el.addEventListener('mousemove', e => {
                  tooltip.style.left = e.pageX + 10 + 'px';
                  tooltip.style.top = e.pageY + 'px';
                });
                info.el.addEventListener('mouseleave', () => {
                  tooltip.style.display = 'none';
                });
              }
            },
            eventClick: function(info) {
                openModal('edit', null, info.event);
            },
            dateClick: function(info) {
              openModal('create', info.dateStr);
            }

          });

          calendar.render();
        });
        function closeModal() {
          document.getElementById('emotionModal').style.display = 'none';
          document.getElementById('modalOverlay').style.display = 'none';
        }
        function openEditForm() {
          document.getElementById('editForm').style.display = 'block';

          // ê¸°ì¡´ ë‚´ìš© ë„£ê¸°
          document.getElementById('editEmoji').value = document.getElementById('modalEmoji').innerText;
          document.getElementById('editDate').value = document.getElementById('modalDate').innerText;
          document.getElementById('editMemo').value = document.getElementById('modalMemo').innerText;
        }


        async function submitEdit() {
          const emoji = document.getElementById('modalEmoji').value;
          const date = document.getElementById('modalDate').value;
          const memo = document.getElementById('modalMemo').value;

          if (!currentEditId) {
            alert("ìˆ˜ì •í•  ê°ì • IDê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const body = {
            emotion: emoji,
            date: date,
            memo: memo
          };

          const response = await fetch(`/api/emotion-entries/${currentEditId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          if (response.ok) {
            alert("ìˆ˜ì • ì™„ë£Œ!");
            closeModal();
            location.reload();
          } else {
            alert("ìˆ˜ì • ì‹¤íŒ¨ ã… ã… ");
          }
        }
        async function submitNewEmotion() {
          const emoji = document.getElementById('modalEmoji').value;
          const date = document.getElementById('modalDate').value;
          const memo = document.getElementById('modalMemo').value;

          const body = { emotion: emoji, date: date, memo: memo };

          const response = await fetch('/api/emotion-entries', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          if (response.ok) {
            alert('ë“±ë¡ ì™„ë£Œ!');
            closeModal();
            location.reload(); // ë˜ëŠ” FullCalendarì—ì„œ refetchEvents() í˜¸ì¶œí•´ë„ ë¨
          } else {
            alert('ë“±ë¡ ì‹¤íŒ¨ ã… ã… ');
          }
        }

    </script>

</body>
</html>
